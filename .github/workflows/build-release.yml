# Build and Release ObeliskFarm executable
# Triggers on version tags (v*)

name: Build Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ObeliskGemEV/requirements.txt
          pip install pyinstaller
      
      - name: Extract version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Inject build version into app
        shell: bash
        run: |
          python - <<'PY'
          import re
          from pathlib import Path

          version = "${{ steps.version.outputs.VERSION }}"
          init_path = Path("ObeliskGemEV/__init__.py")
          text = init_path.read_text(encoding="utf-8")
          text = re.sub(r"^__version__\s*=\s*['\"][^'\"]+['\"]", f"__version__ = \"{version}\"", text, flags=re.M)
          init_path.write_text(text, encoding="utf-8")

          build_info = Path("ObeliskGemEV/build_info.py")
          build_info.write_text(
              "APP_VERSION = " + repr(version) + "\\n" +
              "REPO = " + repr("arisboeuf/ObeliskFarm") + "\\n",
              encoding="utf-8",
          )
          PY

      - name: Read supported Obelisk level
        id: obelisk
        shell: bash
        run: |
          python - <<'PY'
          import os
          import re
          from pathlib import Path

          text = Path("ObeliskGemEV/__init__.py").read_text(encoding="utf-8")
          m = re.search(r"^OBELISK_LEVEL\s*=\s*(\d+)\s*$", text, flags=re.M)
          if not m:
            raise SystemExit("OBELISK_LEVEL not found in ObeliskGemEV/__init__.py")
          level = m.group(1)
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"OBELISK_LEVEL={level}\n")
          PY
      
      - name: Build executable
        run: python -m PyInstaller ObeliskGemEV/ObeliskGemEV.spec --clean

      - name: Rename executable to match tag
        shell: bash
        run: |
          DEST="dist/ObeliskFarm_v${{ steps.version.outputs.VERSION }}.exe"
          SRC="$(ls -1 dist/*.exe | head -n 1)"
          if [ -z "$SRC" ]; then
            echo "No EXE found in dist/"
            exit 1
          fi
          if [ "$SRC" != "$DEST" ]; then
            mv -f "$SRC" "$DEST"
          fi

      - name: Generate SHA256 checksum
        id: checksum
        shell: pwsh
        run: |
          $exe = "dist/ObeliskFarm_v${{ steps.version.outputs.VERSION }}.exe"
          if (!(Test-Path $exe)) { throw "EXE not found: $exe" }
          $hash = (Get-FileHash -Algorithm SHA256 $exe).Hash.ToLower()
          $shaFile = "$exe.sha256"
          "$hash  $(Split-Path $exe -Leaf)" | Out-File -FilePath $shaFile -Encoding ascii
          "SHA256=$hash" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
      
      - name: List output
        run: dir dist
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/ObeliskFarm_v${{ steps.version.outputs.VERSION }}.exe
            dist/ObeliskFarm_v${{ steps.version.outputs.VERSION }}.exe.sha256
          generate_release_notes: true
          body: |
            ## ObeliskFarm v${{ steps.version.outputs.VERSION }}
            
            > ⚠️ **Data based on OB${{ steps.obelisk.outputs.OBELISK_LEVEL }} (Obelisk Level ${{ steps.obelisk.outputs.OBELISK_LEVEL }})**
            
            ### Download
            Download `ObeliskFarm_v${{ steps.version.outputs.VERSION }}.exe` below and run it - no installation required!
            
            ### Security / Verification (optional)
            This EXE is built automatically by GitHub Actions from the source code for this tag.
            
            - Verify checksum (Windows PowerShell):
              `Get-FileHash .\ObeliskFarm_v${{ steps.version.outputs.VERSION }}.exe -Algorithm SHA256`
            - Expected SHA256:
              `${{ steps.checksum.outputs.SHA256 }}`
            - Or use the included file:
              `ObeliskFarm_v${{ steps.version.outputs.VERSION }}.exe.sha256`
            
            ### What's included
            - Freebie EV Calculator
            - Archaeology Simulator
            - Event Budget Optimizer
            - Stargazing Optimizer
            - Lootbug Analyzer
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
